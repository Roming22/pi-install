#cloud-config
#
# https://cloudinit.readthedocs.io/
#

hostname: %host.name%

# Update the system
package_update: true
package_upgrade: true

# On first boot, set the (default) ubuntu user's password
chpasswd:
  expire: false
  list:
  - ubuntu:%user.ubuntu.password%

ssh_authorized_keys:
  - %ssh.ubuntu.authorized_keys%

# Enable password authentication with the SSH daemon
ssh_pwauth: true

users:
- name: pi
  shell: /bin/bash
  ssh-authorized-keys:
    - %ssh.ubuntu.authorized_keys%
  groups:
    - ubuntu
    - docker
  sudo:
    - ALL=(ALL) NOPASSWD:ALL

packages:
  - apt-transport-https
  - ca-certificates
  - curl
  - gnupg-agent
  - software-properties-common

runcmd:
  # Install Docker (https://docs.docker.com/engine/install/ubuntu/)
  - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | apt-key add -
  - add-apt-repository "deb [arch=arm64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"
  - apt-get update -y
  - apt-get install -y docker-ce docker-ce-cli containerd.io
  - systemctl start docker
  - systemctl enable docker

# Reboot after first boot
power_state:
  delay: "now"
  message: Device is configured and up to date. Rebooting...
  mode: reboot
